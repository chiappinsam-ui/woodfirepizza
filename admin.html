<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>
  <style>
    body{font-family:system-ui,Arial;padding:20px;max-width:900px;margin:auto}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px;font-size:16px}
    #list{margin-top:20px;display:grid;gap:10px}
    .item{border:1px solid #ddd;border-radius:10px;padding:10px;display:flex;gap:12px;align-items:center}
    .item img{width:110px;height:70px;object-fit:cover;border-radius:8px}
    .drag{cursor:grab;user-select:none;padding:6px 10px;border:1px solid #ccc;border-radius:8px}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <h1>Owner Admin</h1>

  <div id="authBox">
    <h3>Login</h3>
    <div class="row">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
    </div>
    <p class="muted" id="authMsg"></p>
  </div>

  <div id="adminBox" style="display:none;">
    <div class="row">
      <button id="logoutBtn">Logout</button>
      <button id="shuffleBtn">Shuffle order</button>
      <button id="saveBtn">Save order</button>
      <input id="file" type="file" accept="image/*" />
      <button id="uploadBtn">Upload</button>
    </div>

    <div id="list"></div>
    <p class="muted" id="msg"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "SUPABASE_URL";
    const SUPABASE_ANON_KEY = "SUPABASE_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authBox = document.getElementById("authBox");
    const adminBox = document.getElementById("adminBox");
    const authMsg = document.getElementById("authMsg");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");

    let items = []; // {id, path, sort_order}

    function setMsg(t){ msg.textContent = t || ""; }
    function setAuthMsg(t){ authMsg.textContent = t || ""; }

    async function refreshSessionUI(){
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        authBox.style.display = "none";
        adminBox.style.display = "block";
        await loadItems();
      } else {
        authBox.style.display = "block";
        adminBox.style.display = "none";
      }
    }

    async function login(){
      setAuthMsg("Logging in...");
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return setAuthMsg(error.message);
      setAuthMsg("");
      await refreshSessionUI();
    }

    async function logout(){
      await supabase.auth.signOut();
      await refreshSessionUI();
    }

    function publicUrl(path){
      const { data } = supabase.storage.from("gallery").getPublicUrl(path);
      return data.publicUrl;
    }

    function render(){
      list.innerHTML = "";
      items
        .sort((a,b)=>a.sort_order-b.sort_order)
        .forEach((it, idx) => {
          const div = document.createElement("div");
          div.className = "item";
          div.draggable = true;
          div.dataset.id = it.id;

          div.innerHTML = `
            <span class="drag">↕</span>
            <img src="${publicUrl(it.path)}" alt="" data-img-key="admin-gallery-${it.id}">
            <div style="flex:1">
              <div><b>#${idx+1}</b> <span class="muted">${it.path}</span></div>
            </div>
            <button data-del="${it.id}">Delete</button>
          `;

          // drag reorder
          div.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", it.id);
          });
          div.addEventListener("dragover", e => e.preventDefault());
          div.addEventListener("drop", e => {
            e.preventDefault();
            const fromId = e.dataTransfer.getData("text/plain");
            const toId = it.id;
            reorder(fromId, toId);
          });

          // delete
          div.querySelector("[data-del]").addEventListener("click", async () => {
            await removeItem(it.id);
          });

          list.appendChild(div);
        });
    }

    function reorder(fromId, toId){
      const fromIndex = items.findIndex(x=>x.id===fromId);
      const toIndex = items.findIndex(x=>x.id===toId);
      if (fromIndex < 0 || toIndex < 0) return;

      const [moved] = items.splice(fromIndex, 1);
      items.splice(toIndex, 0, moved);

      // reassign sort_order locally
      items.forEach((x,i)=> x.sort_order = i);
      render();
      setMsg("Order changed (click Save order)");
    }

    function shuffle(){
      for (let i = items.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [items[i], items[j]] = [items[j], items[i]];
      }
      items.forEach((x,i)=> x.sort_order = i);
      render();
      setMsg("Shuffled (click Save order)");
    }

    async function loadItems(){
      setMsg("Loading...");
      const { data, error } = await supabase
        .from("gallery_images")
        .select("id,path,sort_order")
        .eq("active", true)
        .order("sort_order", { ascending: true });

      if (error) return setMsg(error.message);
      items = data || [];
      // normalize sort_order
      items.forEach((x,i)=> x.sort_order = i);
      render();
      setMsg("");
    }

    async function saveOrder(){
      setMsg("Saving order...");
      // update each row with its new sort_order
      for (const it of items) {
        const { error } = await supabase
          .from("gallery_images")
          .update({ sort_order: it.sort_order })
          .eq("id", it.id);
        if (error) return setMsg(error.message);
      }
      setMsg("Saved ✅");
    }

    async function upload(){
      const f = document.getElementById("file").files[0];
      if (!f) return setMsg("Pick a file first.");

      setMsg("Uploading...");
      const safeName = f.name.replace(/[^\w.\-]+/g, "_");
      const path = `uploads/${Date.now()}_${safeName}`;

      const up = await supabase.storage.from("gallery").upload(path, f, { upsert: false });
      if (up.error) return setMsg(up.error.message);

      // set sort_order to end
      const sort_order = items.length;

      const ins = await supabase.from("gallery_images").insert({ path, sort_order, active: true });
      if (ins.error) return setMsg(ins.error.message);

      await loadItems();
      setMsg("Uploaded ✅");
    }

    async function removeItem(id){
      const it = items.find(x=>x.id===id);
      if (!it) return;

      if (!confirm("Delete this photo?")) return;

      setMsg("Deleting...");
      // remove DB row
      const delRow = await supabase.from("gallery_images").delete().eq("id", id);
      if (delRow.error) return setMsg(delRow.error.message);

      // remove file from storage
      const delFile = await supabase.storage.from("gallery").remove([it.path]);
      if (delFile.error) return setMsg(delFile.error.message);

      await loadItems();
      setMsg("Deleted ✅");
    }

    document.getElementById("loginBtn").onclick = login;
    document.getElementById("logoutBtn").onclick = logout;
    document.getElementById("uploadBtn").onclick = upload;
    document.getElementById("shuffleBtn").onclick = shuffle;
    document.getElementById("saveBtn").onclick = saveOrder;

    refreshSessionUI();
  </script>
<script src="/supabase-config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/supabase-init.js"></script>
<script src="/apply-images.js"></script>
<script src="/inline-edit.js"></script>
</body>
</html>
